---
title: "acquisition of TEs"
date: "Last update: Nov 27th 2020"
output: 
  html_document: 
    code_folding: show
    collapsed: no
    df_print: kable
    highlight: espresso
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
# Preparations
## load libraries
```{r}

# install.packages("devtools")
#devtools::install_github("mikabr/ggpirate")

library(ggpirate)
library(here)
library(tidyverse)
library(tidylog)
library(wordbankr)


library(lme4)
library(lmerTest)
library(scales)
```

# load data
```{r}
cdi_ws = readRDS(here::here("Data","output_analyzeSent.Rdata"))
```

# Participant Exclusions
exclude babies out of 18-33m age range, monolinguals and those with >10% 3rd language exposure
```{r}
# exclude kids that are bilingual at one visit, monolingual at another (regardless of direction)
# switch from other to bilingual, or vice versa, or from other to monolingual and vice versa are ok
exclude.lang_group_change  = cdi_ws %>%
  filter(lang_group !="other") %>%
  group_by(baby_id) %>% 
  distinct(ID_testdate, .keep_all = T) %>%
  mutate(visit_num = 1:n()) %>%  
  mutate(changed_language_group_status = if_else(visit_num == 1, NA, 
                                                 lang_group != lag(lang_group))) %>%
  # uncomment see all visits for babies that have one visit excluded
  #filter(any(changed_language_group_status == TRUE) ) %>% View()
  filter(changed_language_group_status == TRUE) %>% 
  pull(ID_testdate)


# Create exclusion criteria variables
cdi_ws_TE <- cdi_ws %>%
  mutate(
    # create an exclusion criteria for language
    exclude.language = case_when(
      # exclude babies with more than 10% exposure to a 3rd language
      lang_exp_other > 10 ~ 1,
      # exclude language group status changed from bilingual to mono or vice versa
      ID_testdate %in% exclude.lang_group_change ~ 1, 
      lang_group == "bilingual" ~ 0, #bilingual
      lang_group == "monolingual" ~ 0, # monolingual
      TRUE ~ 1), # all other cases exlude
    
    # create an exclusion criteria for age
    exclude.age = case_when(!between(age_months_binned, 18, 33) ~ 1, 
                            TRUE ~ 0) # all other cases keep
  )


# Exclude participants
keepers_ws_TE <- cdi_ws_TE %>%
  filter(
    # exclude participants who have exposure to a third language/ are neither bilingual nor monolingual
    exclude.language == 0,
    # exclude participants who don't fit age range
    exclude.age == 0,
    # exclude participants who don't have both CDI filled
    both_cdi_filled == "Y",
    # keep only babies with at least 15% of E and 15% of F (i.e., exclude monolinguals)
    lang_exp_eng >= 15 & lang_exp_eng <= 85,
    lang_exp_fre >= 15 & lang_exp_fre <= 85)


### Check how many distinct participants and data point we have
keepers_ws_TE %>% summarize(N_visits = n_distinct(ID_testdate),
                            N_babies = n_distinct(baby_id),
                            N_admin = sum(n_administrations, na.rm=T))


### Check if there is any NAs in the vocabulary measures (should all return 0)
keepers_ws_TE %>% filter(is.na(vocab_score)) %>% 
  select(ID_testdate, vocab_type, vocab_score) %>%
  nrow()

keepers_ws_TE %>% filter(is.na(eng_unique_words)) %>% 
  select(ID_testdate) %>% 
  nrow()

keepers_ws_TE %>% filter(is.na(fre_unique_words)) %>% 
  select(ID_testdate) %>%
  nrow()

keepers_ws_TE %>% filter(is.na(number_of_te)) %>% 
  select(ID_testdate) %>%
  nrow()
```

# Prepare the dataset
```{r}

keepers_ws_TE = keepers_ws_TE %>%
  # keep only necessary variables
  select(-c(vocab_type_dom, vocab_cross_lang, n_administrations)) %>% #n_administrations
  spread(vocab_type, vocab_score) %>%
  
  ######
  rename(baby_id = Baby_ID, age_months_binned = age.months,
         word_vocab = Totalvocabulary,
         total_words_eng = TotalNW_Eng, total_words_fre = TotalNW_Fr,
         eng_unique_words = Eng_unique_words, fre_unique_words = Fr_unique_words,
         number_of_te = TotalnumberTEs,
         lang_exp_eng = LangExpEng, lang_exp_fre = LangExpFr, lang_exp_other = LangExpOther) %>%
  
  # calculate age in months (with decimal)
  mutate(age_month_decimal = age_days/30) %>%
  # create balance groups (by exposure)
  mutate(BalanceGroup_byExposure = cut(balance, breaks = 4, 
                                       labels = c("80_20", "70_30", "60_40", "50_50"))) %>%
  mutate(TotalNW_Dom_exposure = case_when(lang_dom == "English" ~ total_words_eng,
                                          lang_dom == "French" ~ total_words_fre),
         TotalNW_NonDom_exposure = case_when(lang_dom == "English" ~ total_words_fre,
                                             lang_dom == "French" ~ total_words_eng),
         Dom_unique_words_exposure = case_when(lang_dom == "French" ~ fre_unique_words, 
                                               lang_dom == "English" ~ eng_unique_words),
         NonDom_unique_words_exposure = case_when(lang_dom == "French" ~ eng_unique_words, 
                                         lang_dom == "English" ~ fre_unique_words)) %>%
  
  #defining dominance based on vocabulary size
  mutate(LangDom_vocab = case_when(total_words_eng > total_words_fre ~ "English",
                                 TRUE ~ "French")) %>%
  mutate(LangDom_vocab = as.factor(LangDom_vocab)) %>%
  mutate(TotalNW_Dom = case_when(total_words_eng > total_words_fre ~ total_words_eng,
                                 TRUE ~ total_words_fre),
         TotalNW_NonDom = case_when(total_words_eng > total_words_fre ~ total_words_fre,
                                    TRUE ~ total_words_eng),
         Dom_unique_words = case_when(total_words_eng > total_words_fre ~ eng_unique_words,
                                      TRUE ~ fre_unique_words),
         NonDom_unique_words = case_when(total_words_eng > total_words_fre ~ fre_unique_words,
                                         TRUE ~ eng_unique_words)) %>%
  mutate(TotalUnique = Dom_unique_words + NonDom_unique_words) %>%
  
  #Defining vocabulary-based balance score
  mutate(balance_vocab = TotalNW_NonDom/TotalNW_Dom) %>%
  #Defining proportion of TE (with reference to child's own total vocab size)
  mutate(propTE = number_of_te*2/word_vocab) %>% 
  #Defining proportion of TE (with reference to CDI)
  mutate(propTE_CDI = number_of_te/672) 
  

# check balancedness cutoffs
keepers_ws_TE %>%
  ggplot(aes(x = lang_exp_eng, y = BalanceGroup_byExposure)) + 
  geom_point()

keepers_ws_TE %>%
  ggplot(aes(x = lang_exp_fre, y = BalanceGroup_byExposure)) + 
  geom_point()

```

# Descriptives
## number of CDIs & Babys
```{r}
# how many unique babies
keepers_ws_TE %>%
  distinct(baby_id) %>%
  count()

keepers_ws_TE %>%
  distinct(participant_id) %>%
  count()

# some babies made multiple visits to the lab
keepers_ws_TE %>% 
  distinct(ID_testdate) %>% 
  count()

N_duplicatedBabyID <- keepers_ws_TE %>%
  filter(duplicated(baby_id))

# Create dataframe of demographics
d_participants <- keepers_ws_TE %>%
  filter(vocab_type == "word_vocab") %>%
  select(baby_id, age_days, gender, 
         lang_exp_eng, lang_exp_fre, lang_exp_other, years_education) %>%
  mutate(Female = ifelse(gender == "F", 1, 0)) %>%
  summarise(n = n(),
            age.days = mean(age_days, na.rm = TRUE),
            lang_exp_eng = mean(lang_exp_eng, na.rm = TRUE),
            lang_exp_fre = mean(lang_exp_fre, na.rm = TRUE), 
            lang_exp_other = mean(lang_exp_other, na.rm = TRUE),
            years_education = mean(years_education, na.rm = TRUE),
            number_female = sum(Female))
```

## Gender 
```{r}
keepers_ws_TE %>%
  group_by(Gender) %>% 
  distinct(baby_id, .keep.all=T) %>%
  count()
```

## English dominant
```{r}
# dominance defined by language exposure
keepers_ws_TE %>% group_by(lang_dom) %>% distinct(baby_id) %>%
  count()

# dominance defined by vocab size
keepers_ws_TE %>% group_by(LangDom_vocab) %>% distinct(baby_id) %>%
  count()
```

## years of maternal education
```{r}
keepers_ws_TE %>% distinct(baby_id, .keep_all = T) %>%
  summarize(mean = mean(years_education, na.rm=T), 
            sd = sd(years_education, na.rm=T))
```

## age range, mean
```{r}
keepers_ws_TE %>%
  distinct(baby_id, .keep_all = T) %>% 
  summarize(sd = sd(age_days, na.rm=T))

do.call(cbind, lapply(keepers_ws_TE %>%
                        distinct(baby_ID, .keep_all = T) %>% 
                        select(age_days,age_continuous),
                      summary))

```

## average # of TEs
```{r}
keepers_ws_TE %>%
  filter(bothCDI_filled=="Y") %>%
  summarise(mean = mean(propTE, na.rm=T), 
            min= min(propTE, na.rm=T),
            max= max(propTE, na.rm=T))

```


## Percentile information from WordbankR
```{r}

## English Word&Sentence: Vocabulary size at 90% percentile
english_ws_percentile <-  
  fit_vocab_quantiles(get_administration_data("English (American)", "WS"), 
                      production,
                      quantile = "standard") %>%
  # keep only the 90% percentile
  filter(quantile == 0.90) %>%
  rename(EngWS_90percentile = production)

## Canadian French Word&Sentence: Vocabulary size at 90% percentile
french_ws_percentile <-  
  fit_vocab_quantiles(get_administration_data("French (Quebecois)", "WS"), 
                      production,
                      quantile = "standard") %>%
  # keep only the 90% percentile
  filter(quantile == 0.90) %>%
  rename(FrWS_90percentile = production)

## Merge the two percentile dataframe
ws_percentile <- merge(english_ws_percentile, french_ws_percentile, 
                       by = "age") %>%
  # compute estimate total vocab by adding the two languages
  mutate(Total_90percentile = EngWS_90percentile + FrWS_90percentile) %>%
  # keep only necessary columns
  select(age, EngWS_90percentile, FrWS_90percentile, Total_90percentile) %>%
  # rename age to prepare for the next step (i.e., merging with keepers_ws_TE
  rename(age_months_percentile = age)
```

# Adding percentile info to keepers_ws_TE dataframe & 
## Creating a new propTE based on the percentile
```{r}
# merge the dataframes
keepers_ws_TE <- keepers_ws_TE %>%
  # as the upper age limit of the CDI-WS is 30m, create a new age variable which replaces all >30m as 30m for merging with the percentile dataframe
  # this means the percentile should be the same for all >30m
  mutate(age_months_percentile = ifelse(age_months_binned > 30, 30, age_months_binned)) %>%
  # merge with the percentile data frame
  left_join(ws_percentile, by = "age_months_percentile") %>%
  # calculate TE in relation to CDI percentile data
  mutate(propTE_percentile = number_of_te*2/Total_90percentile)
  # %>% select(baby_id, age_months_binned, age_months_percentile, word_vocab, Total_90percentile,
  #       propTE, propTE_CDI, propTE_percentile)

# check if any baby learn more words than the percentile
# (there are 2 babies know more than the percentile in their dominant language)
MoreThanPercentile <- keepers_ws_TE %>%
  select(ID_testdate, age_months_binned, lang_dom, LangDom_vocab, 
         word_vocab, total_words_eng, EngWS_90percentile, 
         total_words_fre, FrWS_90percentile, word_vocab, Total_90percentile) %>%
  filter(total_words_eng > EngWS_90percentile | 
           total_words_fre > FrWS_90percentile |
           word_vocab > Total_90percentile)
```

## Create predicted TEs for simulation
```{r}
keepers_ws_TE_simulation <- keepers_ws_TE %>%
  # Predicted propTE (Simulation)
  mutate(propDomVocab = TotalNW_Dom / 672, # Proportion of Dom/NonDom vocab
         propNonDomVocab = TotalNW_NonDom / 672, 
         Predicted_propTE = propDomVocab * propNonDomVocab, # Predicted proportion of TE
         Diff = propTE - Predicted_propTE) %>% # Difference between Predicted and Observed propTE
  # Predicted raw TE (with reference to CDI)
  mutate(Predicted_TotalnumberTEs_CDI = (TotalNW_Dom * TotalNW_NonDom)/672) %>%
  # Predicted raw TE (with reference to CDI percentile)
  mutate(Predicted_TotalnumberTEs_percentile = TotalNW_Dom * TotalNW_NonDom/(Total_90percentile/2)) %>%
  # Create two groups based on observed TE
  mutate(TEgroup = ifelse(number_of_te < 100, "Observed TE less than 100", "Observed TE more than 100"))
  
  
  #select(baby_id, age_months_binned, age_months_percentile, word_vocab, Total_90percentile,
  #       propTE, propTE_CDI, propTE_percentile, Predicted_propTE, Diff, 
  #       Predicted_TotalnumberTEs_CDI, Predicted_TotalnumberTEs_percentile) 

  

```

###### Linear regressions of predicted TE models ###### 
```{r}

### Model 1: Predicted_TotalnumberTEs_percentile
Prediction_model <- keepers_ws_TE_simulation %>%
  lm(number_of_te*(Total_90percentile/2) ~ 0 + TotalNW_Dom:TotalNW_NonDom, 
     data = .)

### Model 2: Predicted_TotalnumberTEs_CDI
CDI_model <- keepers_ws_TE_simulation %>%
  lm(number_of_te * 672 ~ 0 + TotalNW_Dom:TotalNW_NonDom, 
     data = .) 

anova(Percentile_model, CDI_model)
```

###### Theoretical distribution of TEs (Simulation) ###### 
```{r}
###Prediction 1: Predicted raw TE = (TotalNW_Dom*TotalNW_NonDom)/Total CDI
# Ploting Y = observed rawTE  & X = Predicted raw TE 

keepers_ws_TE_simulation %>%
  ggplot(aes(x = Predicted_TotalnumberTEs_CDI, y = number_of_te)) +
  facet_grid(. ~TEgroup) +
  labs(x = "Predicted total number of TEs (based on CDI)", y = "Observed total number of TEs",
       title = "Observed vs. Predicted total number of TEs") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,430) +
  ylim(-10,430)

# Kolmogorov-Smirnov test to compare the observed and predicted TE
stats::ks.test(keepers_ws_TE_simulation$number_of_te,
               keepers_ws_TE_simulation$Predicted_TotalnumberTEs_CDI)

###Prediction 2: Predicted raw TE = TotalNW_Dom * TotalNW_NonDom/(Total_90percentile/2)
# Ploting Y = observed rawTE  & X = Predicted raw TE 

TEprediction_percentile <- keepers_ws_TE_simulation %>%
  ggplot(aes(x = Predicted_TotalnumberTEs_percentile, y = number_of_te)) +
  facet_grid(. ~TEgroup) +
  labs(x = "Predicted total number of TEs (based on percentile)", y = "Observed total number of TEs",
       title = "Observed vs. Predicted total number of TEs") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,430) +
  ylim(-10,430)

ggsave(here("TEprediction_percentile.png"), TEprediction_percentile)

# Kolmogorov-Smirnov test to compare the observed and predicted TE
stats::ks.test(keepers_ws_TE_simulation$number_of_te,
               keepers_ws_TE_simulation$Predicted_TotalnumberTEs_percentile)

keepers_ws_TE_simulation_LessThan10 <- keepers_ws_TE_simulation %>%
  filter(TEgroup == "Observed TE less than 100")

stats::ks.test(keepers_ws_TE_simulation_LessThan10$number_of_te,
               keepers_ws_TE_simulation_LessThan10$Predicted_TotalnumberTEs_percentile)

keepers_ws_TE_simulation_MoreThan10 <- keepers_ws_TE_simulation %>%
  filter(TEgroup == "Observed TE more than 100")

stats::ks.test(keepers_ws_TE_simulation_MoreThan10$number_of_te,
               keepers_ws_TE_simulation_MoreThan10$Predicted_TotalnumberTEs_percentile)



### Plotting the 2 predictions together

TEprediction_percentile_CDI <- keepers_ws_TE_simulation %>%
  select(baby_id, number_of_te, Predicted_TotalnumberTEs_CDI, Predicted_TotalnumberTEs_percentile, TEgroup) %>%
  dplyr::rename("=Dom*NonDom/TotalCDI" = Predicted_TotalnumberTEs_CDI,
                "=Dom*NonDom/Percentile" = Predicted_TotalnumberTEs_percentile) %>%
  pivot_longer(-c(baby_id, number_of_te, TEgroup), 
               names_to = "Predicted_TotalnumberTEs", values_to = "PredictedNumber") %>%
  ggplot(aes(x = PredictedNumber, y = number_of_te, color = Predicted_TotalnumberTEs)) +
  facet_grid(. ~TEgroup) +
  labs(x = "Predicted total number of TEs", 
       y = "Observed total number of TEs",
       title = 
       "Observed vs. Predicted total number of TEs") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,500) +
  ylim(-10,500) +
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom") +
  guides(colour = guide_legend(nrow = 1))

ggsave(here("TEprediction_percentile&CDI.png"), TEprediction_percentile_CDI)

#Less Than 100 observed TEs
TEprediction_percentile_CDI_LessThan100 <- keepers_ws_TE_simulation %>%
  filter(TEgroup == "Observed TE less than 100") %>%
  select(baby_id, number_of_te, Predicted_TotalnumberTEs_CDI, Predicted_TotalnumberTEs_percentile) %>%
  dplyr::rename("=Dom*NonDom/TotalCDI" = Predicted_TotalnumberTEs_CDI,
                "=Dom*NonDom/Percentile" = Predicted_TotalnumberTEs_percentile) %>%
  pivot_longer(-c(baby_id, number_of_te), 
               names_to = "Predicted_TotalnumberTEs", values_to = "PredictedNumber") %>%
  ggplot(aes(x = PredictedNumber, y = number_of_te, color = Predicted_TotalnumberTEs)) +
  labs(x = "Predicted total number of TEs", 
       y = "Observed total number of TEs",
       title = 
       "Observed vs. Predicted total number of TEs \n (Less than 100 observed TEs)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,100) +
  ylim(-10,100) +
  theme(plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x = element_text(angle = 90), 
        legend.position = "bottom", legend.text=element_text(size = 10)) +
  guides(colour = guide_legend(nrow = 2))

ggsave(here("TEprediction_percentile&CDI_LessThan100.png"), TEprediction_percentile_CDI_LessThan100)

#Less Than 50 observed TEs
TEprediction_percentile_CDI_LessThan50 <- keepers_ws_TE_simulation %>%
  filter(number_of_te < 50) %>%
  select(baby_id, number_of_te, Predicted_TotalnumberTEs_CDI, Predicted_TotalnumberTEs_percentile) %>%
  dplyr::rename("=Dom*NonDom/TotalCDI" = Predicted_TotalnumberTEs_CDI,
                "=Dom*NonDom/Percentile" = Predicted_TotalnumberTEs_percentile) %>%
  pivot_longer(-c(baby_id, number_of_te), 
               names_to = "Predicted_TotalnumberTEs", values_to = "PredictedNumber") %>%
  ggplot(aes(x = PredictedNumber, y = number_of_te, color = Predicted_TotalnumberTEs)) +
  labs(x = "Predicted total number of TEs", 
       y = "Observed total number of TEs",
       title = 
       "Observed vs. Predicted total number of TEs \n (Less than 50 observed TEs)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,50) +
  ylim(-10,50) +
  theme(plot.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90), 
        legend.position = "bottom", legend.box="vertical", legend.text=element_text(size = 10)) +
  guides(colour = guide_legend(nrow = 2))

ggsave(here("TEprediction_percentile&CDI_LessThan50.png"), TEprediction_percentile_CDI_LessThan50)


# More than 100 Observed TEs
TEprediction_percentile_CDI_MoreThan100 <- keepers_ws_TE_simulation %>%
  filter(TEgroup == "Observed TE more than 100") %>%
  select(baby_id, number_of_te, Predicted_TotalnumberTEs_CDI, Predicted_TotalnumberTEs_percentile) %>%
  dplyr::rename("=Dom*NonDom/TotalCDI" = Predicted_TotalnumberTEs_CDI,
                "=Dom*NonDom/Percentile" = Predicted_TotalnumberTEs_percentile) %>%
  pivot_longer(-c(baby_id, number_of_te), 
               names_to = "Predicted_TotalnumberTEs", values_to = "PredictedNumber") %>%
  ggplot(aes(x = PredictedNumber, y = number_of_te, color = Predicted_TotalnumberTEs)) +
  labs(x = "Predicted total number of TEs", 
       y = "Observed total number of TEs",
       title = "Observed vs. Predicted total number of TEs \n (More than 100 observed TEs)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = "lm", se = F) +
  geom_point(shape = 23) +
  geom_abline(linetype = 2, alpha = 0.5) +
  xlim(-10,500) +
  ylim(-10,500) +
  theme(plot.title = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 90), 
        legend.position = "bottom", legend.text=element_text(size=10)) +
  guides(colour = guide_legend(nrow = 2))

ggsave(here("TEprediction_percentile&CDI_MoreThan100.png"), TEprediction_percentile_CDI_MoreThan100)


###Prediction 2: Predicted raw TE = TotalNW_NonDom
# Ploting Y = observed rawTE  & X = Predicted raw TE 

#keepers_ws_TE_simulation%>%
#  ggplot(aes(x = TotalNW_NonDom, y = number_of_te)) +
#  labs(x = "Predicted total number of TEs", 
#       y = "Observed total number of TEs",
#       title = 
#       "Observed vs. Predicted total number of TEs 
#       (based on total number of NonDom vocab)") +
#  theme(plot.title = element_text(hjust = 0.5)) +
#  geom_smooth(method = "lm", se = F) +
#  geom_point(shape = 23) +
#  geom_abline(linetype = 2, alpha = 0.5) +
#  xlim(-10,500) +
#  ylim(-10,500)

## Kolmogorov-Smirnov test to compare the observed and predicted TE
#stats::ks.test(keepers_ws_TE_simulation$TotalnumberTEs, keepers_ws_TE_simulation$TotalNW_NonDom)

```





















# plots
## proportion of TEs
```{r}
keepers_ws_TE %>%
  filter(vocab_type=="Totalvocabulary", bothCDI_filled=="Y") %>%
  ggplot(aes(x = age.days/30, 
             y = propTE)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 2))+
  ylab("Percentage of Translation Equivalents") +
  xlab("Age in Months")+
  ggtitle("Percentage of Translation Equivalents by Age") +  
  theme_classic(base_size = 22) +
  scale_x_continuous(breaks= seq(18,32,by = 2))+
  geom_point(size=3) + 
  geom_smooth(method="lm" )

ggsave(here("Output","PlotbyAge.png"), height=10,width=10)
```

## Bar graphs with individual scores (percentage TEs by dominance)
```{r}
keepers_ws_summarize = keepers_ws_TE %>% 
  group_by(balance_group15) %>%
  summarize(mean = mean(propTE, na.rm = T),
         N = n(),
         sd = sd(propTE, na.rm=T),
         se = sd(propTE, na.rm = T)/ sqrt(N)) 


ggplot(data=keepers_ws_summarize,
       aes(x=balance_group15,
           y=mean)) +
    geom_bar(aes(fill = balance_group15),
             show.legend =F,
             colour="black",
             stat="identity",
             position="dodge", width=.7) +
  
   geom_point(data = keepers_ws_TE,aes( y = propTE, fill = balance_group15), alpha = 0.9, show.legend = F, color = "black", pch = 21,size=1.75, 
   stat = "identity",position=position_jitterdodge()) +
  geom_errorbar(aes(ymin = mean - se, 
                    ymax = mean + se), 
                width=0.2,
                position=position_dodge(.9)) +
    ylab("Percentage of Translation Equivalents\n") +
    xlab("Balance") +
scale_x_discrete(breaks= c("80_20", "70_30", "60_40", "50_50"),
                        labels =c("80:20","70:30","60:40","50:50"))+
    ggtitle("Percentage of Translation Equivalents by Balance") +
    theme_classic(base_size = 22) +
  scale_y_continuous(labels = scales::percent_format(accuracy=2))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1), 
          plot.title = element_text(hjust = .5))

ggsave(here("output","PlotTE_byBalance.png"), width=9.5, height= 7)
```
## age by balancedness
```{r}
keepers_ws_TE %>%
  filter(vocab_type=="Totalvocabulary", bothCDI_filled=="Y") %>%
  group_by(balance_group15) %>%
  summarize(median.age = median(age.days))


keepers_ws_TE %>%
  filter(vocab_type=="Totalvocabulary", bothCDI_filled=="Y") %>%
  ggplot(aes(x=balance_group15, y=age.days/30, colour=balance_group15))+
  geom_pirate(bars=F) +ylab("Age (Months)") + coord_flip()

```





## TE: age plot by balancedness
```{r}
keepers_ws_TE %>%
  filter(vocab_type=="Totalvocabulary", bothCDI_filled=="Y") %>%
  ggplot(aes(x = age.days/30, 
             y = propTE)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 2))+
  ylab("Percentage of Translation Equivalents\n") +
  xlab("Age in Months")+
  ggtitle("Percentage of Translation Equivalents by Age and Balance") +  guides(colour = guide_legend(reverse=TRUE))+

  theme_classic(base_size = 22) +
 # scale_x_continuous(breaks= seq(18,32,by = 2))+
  geom_point(size=3, colour= "darkgrey") + 
  geom_smooth(size =2, aes(colour=balance_group15), method="lm", se=F)+
  scale_colour_discrete(name="Balance", 
                        breaks= c("80_20", "70_30", "60_40", "50_50"),
                        labels =c("least balanced (80:20)","less balanced (70:30)","more balanced (60:40)","most balanced (50:50)"))
ggsave(here("Output","PlotTE_BalanceByAge.png"), width=13, height= 7)


```







# Statistical tests
## ANOVA for balance
```{r}
res.aov <- aov(propTE ~ balance_group15*cent.age.months, data=keepers_ws_TE) 
summary(res.aov)
```

## Age (old code, not used for poster)
### Running linear model
```{r}
  linear.model<-lmer(propTE ~ cent.age.months+ (1|Baby_ID), data = keepers_ws_TE)
  summary(linear.model)
```
### Running quadratic model
```{r}
 quadratic.model <-lmer(propTE ~ poly(cent.age.months,2) + (1|Baby_ID), data = keepers_ws_TE)
  summary(quadratic.model)
```
### Cubic model
```{r}
cubic.model<-lm(propTE ~ poly(cent.age.months,3), data = keepers_ws_TE)
summary(cubic.model)
```


